{% extends "base.html" %}

{% block title %}Dashboard - Polymarket Analytics{% endblock %}

{% block content %}
<h1>Dashboard</h1>

{% if overview.is_data_stale %}
<div class="alert alert-warning" style="background: #fef3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 16px; margin-bottom: 24px;">
    <strong>Data is stale!</strong> Last update was {{ "%.1f"|format(overview.data_age_hours) }} hours ago.
    <br>Run <code style="background: #fff3cd; padding: 2px 6px; border-radius: 4px;">python cli.py collect</code> to fetch fresh data from Polymarket.
</div>
{% elif overview.last_data_update %}
<div class="data-freshness" style="color: #6b7280; font-size: 14px; margin-bottom: 16px;">
    Last updated: {{ overview.last_data_update.strftime('%Y-%m-%d %H:%M') }} UTC
    {% if overview.data_age_hours %}({{ "%.1f"|format(overview.data_age_hours) }} hours ago){% endif %}
</div>
{% endif %}

<div class="stats-grid">
    <div class="stat-card">
        <h3>Total Tracked</h3>
        <div class="stat-value">{{ overview.total_tracked }}</div>
        <div class="stat-label">markets</div>
    </div>
    <div class="stat-card">
        <h3>Active</h3>
        <div class="stat-value">{{ overview.active_markets }}</div>
        <div class="stat-label">markets</div>
    </div>
    <div class="stat-card">
        <h3>Resolved</h3>
        <div class="stat-value">{{ overview.resolved_markets }}</div>
        <div class="stat-label">markets</div>
    </div>
    <div class="stat-card">
        <h3>Snapshots</h3>
        <div class="stat-value">{{ overview.total_snapshots }}</div>
        <div class="stat-label">data points</div>
    </div>
    <div class="stat-card highlight">
        <h3>Black Swans</h3>
        <div class="stat-value">{% if black_swans %}{{ black_swans|length }}{% else %}{{ overview.black_swan_count }}{% endif %}</div>
        <div class="stat-label">{% if black_swans %}from API{% else %}events{% endif %}</div>
    </div>
    <div class="stat-card">
        <h3>Active Markets</h3>
        <div class="stat-value">{% if movers %}{{ movers|length }}{% else %}{{ overview.recent_large_moves }}{% endif %}</div>
        <div class="stat-label">top movers</div>
    </div>
</div>

<section class="section">
    <h2>Accuracy by Probability Bucket</h2>
    <div class="chart-container">
        <canvas id="bucketChart"></canvas>
    </div>
    <table class="data-table">
        <thead>
            <tr>
                <th>Bucket</th>
                <th>Resolved</th>
                <th>Correct</th>
                <th>Accuracy</th>
                <th>Black Swans</th>
            </tr>
        </thead>
        <tbody>
            {% for bucket in overview.bucket_stats %}
            {% if bucket.total_resolved > 0 %}
            <tr>
                <td>{{ bucket.bucket }}</td>
                <td>{{ bucket.total_resolved }}</td>
                <td>{{ bucket.correct_predictions }}</td>
                <td>{{ "%.1f"|format(bucket.accuracy_rate) }}%</td>
                <td>{{ bucket.black_swan_count }}</td>
            </tr>
            {% endif %}
            {% endfor %}
        </tbody>
    </table>
</section>

<div class="two-column">
    <section class="section">
        <h2>Top Markets by Volume</h2>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Market</th>
                    <th>Prob</th>
                    <th>Volume</th>
                </tr>
            </thead>
            <tbody>
                {% for market in markets[:10] %}
                <tr>
                    <td>
                        <a href="/market/{{ market.id }}">
                            {{ market.question[:50] }}{% if market.question|length > 50 %}...{% endif %}
                        </a>
                    </td>
                    <td class="prob-cell">{{ "%.1f"|format(market.probability) }}%</td>
                    <td>${{ "{:,.0f}".format(market.volume) }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <a href="/markets" class="btn">View All Markets</a>
    </section>

    <section class="section">
        <h2>Recent Big Movers</h2>
        {% if movers %}
        <table class="data-table">
            <thead>
                <tr>
                    <th>Market</th>
                    <th>Change</th>
                    <th>From/To</th>
                </tr>
            </thead>
            <tbody>
                {% for mover in movers[:10] %}
                <tr>
                    <td>
                        <a href="/market/{{ mover.market_id }}">
                            {{ mover.question[:40] }}{% if mover.question|length > 40 %}...{% endif %}
                        </a>
                    </td>
                    <td class="{% if mover.change_points > 0 %}positive{% else %}negative{% endif %}">
                        {% if mover.change_points > 0 %}+{% endif %}{{ "%.1f"|format(mover.change_points) }}pts
                    </td>
                    <td>{{ "%.0f"|format(mover.probability_start) }}% &rarr; {{ "%.0f"|format(mover.probability_end) }}%</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p style="color: #6b7280; padding: 20px;">Loading market data from Polymarket API...</p>
        {% endif %}
        <a href="/movers" class="btn">View All Movers</a>
    </section>
</div>

{% if black_swans %}
<section class="section">
    <h2>Recent Black Swan Events</h2>
    <p class="subtitle" style="color: #6b7280; margin-bottom: 16px;">Markets where the underdog won (from Polymarket API)</p>
    <table class="data-table">
        <thead>
            <tr>
                <th>Market</th>
                <th>Winner</th>
                <th>Early Odds</th>
                <th>Volume</th>
            </tr>
        </thead>
        <tbody>
            {% for swan in black_swans[:5] %}
            <tr>
                <td>
                    <a href="/market/{{ swan.market_id }}">
                        {{ swan.question[:50] }}{% if swan.question|length > 50 %}...{% endif %}
                    </a>
                </td>
                <td><span class="badge">{{ swan.winning_outcome }}</span></td>
                <td class="negative">{{ "%.0f"|format(swan.early_probability or 0) }}%</td>
                <td>${{ "{:,.0f}".format(swan.volume) }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <a href="/black-swans" class="btn">View All Black Swans</a>
</section>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
const bucketData = {{ bucket_stats_json | tojson | safe }};
const ctx = document.getElementById('bucketChart').getContext('2d');

new Chart(ctx, {
    type: 'bar',
    data: {
        labels: bucketData.filter(b => b.total_resolved > 0).map(b => b.bucket),
        datasets: [{
            label: 'Accuracy %',
            data: bucketData.filter(b => b.total_resolved > 0).map(b => b.accuracy_rate),
            backgroundColor: 'rgba(59, 130, 246, 0.7)',
            borderColor: 'rgba(59, 130, 246, 1)',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                max: 100,
                title: {
                    display: true,
                    text: 'Accuracy %'
                }
            }
        },
        plugins: {
            legend: {
                display: false
            }
        }
    }
});
</script>
{% endblock %}
