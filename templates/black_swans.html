{% extends "base.html" %}

{% block title %}Black Swans - Polymarket Analytics{% endblock %}

{% block content %}
<h1>Black Swan Events</h1>
<p class="subtitle">Markets with dramatic confidence reversals - high certainty that flipped and resolved unexpectedly</p>

<div class="filters">
    <label>Data source:</label>
    <a href="?source=api" class="btn {% if source == 'api' %}active{% endif %}">Polymarket API</a>
    <a href="?source=local" class="btn {% if source == 'local' %}active{% endif %}">Local Tracked</a>
</div>

<p class="info-text">Source: {{ source_label }}</p>

<div class="detection-criteria">
    <h3>Detection Criteria</h3>
    <ul>
        <li><strong>Winning outcome traded below 40%</strong> at 14, 7, or 3 days before resolution</li>
        <li><strong>Minimum volume:</strong> $100,000</li>
        <li><strong>Time range:</strong> Resolved in the last 60 days</li>
    </ul>
</div>

{% if black_swans %}
<div class="column-legend">
    <h4>Column Guide</h4>
    <ul>
        <li><strong>Early Prob</strong> - Lowest recorded probability of the winning outcome (lower = bigger upset)</li>
        <li><strong>Early Date</strong> - When the low probability was recorded</li>
        <li><strong>Final Prob</strong> - Probability at resolution (100% = winner)</li>
        <li><strong>Resolved</strong> - Date market resolved</li>
    </ul>
</div>

<table class="data-table full-width">
    <thead>
        <tr>
            <th>Market</th>
            <th title="The outcome that ultimately won">Winner</th>
            <th title="Lowest recorded probability of the winning outcome">Early Prob</th>
            <th title="Date when the low probability was recorded">Early Date</th>
            <th title="Final probability at resolution">Final Prob</th>
            <th title="Date the market resolved">Resolved</th>
            <th title="Total trading volume in USD">Volume</th>
        </tr>
    </thead>
    <tbody>
        {% for swan in black_swans %}
        <tr class="black-swan-row">
            <td>
                {% if source == 'api' %}
                <a href="https://polymarket.com/event/{{ swan.market_id }}" target="_blank" rel="noopener">
                    {{ swan.question }}
                </a>
                {% else %}
                <a href="/market/{{ swan.market_id }}">{{ swan.question }}</a>
                {% endif %}
            </td>
            <td>
                <span class="outcome-badge">{{ swan.winning_outcome or swan.outcome or '-' }}</span>
            </td>
            <td>
                {% if swan.early_probability %}
                <span class="prob-badge upset">{{ "%.1f"|format(swan.early_probability) }}%</span>
                {% else %}
                -
                {% endif %}
            </td>
            <td class="date-cell">{{ swan.early_date[:10] if swan.early_date else '-' }}</td>
            <td>
                {% if swan.final_probability %}
                <span class="prob-badge winner">{{ "%.0f"|format(swan.final_probability) }}%</span>
                {% else %}
                -
                {% endif %}
            </td>
            <td class="date-cell">{{ (swan.end_date or swan.resolved_at)[:10] if (swan.end_date or swan.resolved_at) else '-' }}</td>
            <td>
                {% if swan.volume %}
                ${{ "{:,.0f}".format(swan.volume) }}
                {% else %}
                -
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<div class="empty-state">
    {% if source == 'api' %}
    <h3>Searching for Black Swans...</h3>
    <p>No black swan events found in the last 60 days with the current criteria.</p>
    <p>This searches for markets where the winning outcome was trading below 40% at some point before resolution.</p>
    {% else %}
    <h3>No Black Swans Detected Yet</h3>
    <p>Black swan events are detected when tracked markets resolve.</p>
    <p>To see black swans:</p>
    <ul>
        <li>Run data collection regularly: <code>python cli.py collect</code></li>
        <li>Wait for tracked markets to resolve (check markets resolving soon)</li>
        <li>Black swans are automatically detected when resolutions occur</li>
    </ul>
    <p>Or switch to <a href="?source=api">Polymarket API</a> to search all recent resolved markets.</p>
    {% endif %}
</div>
{% endif %}

<section class="section">
    <h2>Why Track Black Swans?</h2>
    <p>
        Black swan events reveal when prediction markets fail - moments when the crowd was confidently
        wrong about an outcome. The "Early Prob" column shows how low the winning outcome was trading
        before it won (lower = more dramatic upset).
    </p>
    <p>
        Studying these events helps identify market blind spots, understand what signals were missed,
        and improve forecasting models.
    </p>
</section>
{% endblock %}
